# Assisted Prison Visits Scheme (APVS)

[![Build Status](https://travis-ci.org/ministryofjustice/apvs.svg?branch=develop)](https://travis-ci.org/ministryofjustice/apvs?branch=develop)
[![JavaScript Style Guide](https://img.shields.io/badge/code%20style-standard-brightgreen.svg)](http://standardjs.com/)

Prototype implementation of the Assisted Prison Visits Scheme alpha. A bare bones implementation of the system intended to assist with technical spikes.

## Requirements

* docker (with docker-compose)
* Node 6 (including npm)

## Run

Use docker-compose to build and launch the containers for the solution.

There are four node.js application containers
* External facing site for claimants seeking to apply for APVS
* External API for business logic
* Internal facing site for APVS providers to administer the scheme
* Notify Worker - example process to execute tasks for email notifications

The node applications are linked to a mongo database container.

Run the application:
```
docker-compose up

# Force a rebuild of the containers if package.json has changed to get new dependencies
#docker-compose up --build
```

When running in development, volumes are mapped from the containers to the host so changes to host files trigger the application to restart ([nodemon](http://nodemon.io/)) and node_modules dependencies are cached so they don't need to be retrieved each time.

## Configuration
Optional configuration for the prototype.

### Bunyan Logging
The prototype uses the Bunyan Logging library to produce JSON logs which it outputs to file, console, and optionally an ELK instance (see [ELK Stack](#elk_stack)).

- LOGGING_PATH :: Sets the path to output Bunyan log files. Defaults to 'logs/external-web.log' & 'logs/internal-web.log'.

### ELK Stack
The prototype has been configured to stream log messages from the Bunyan logger to an instance of the ELK stack running in a Docker container. By default this is disabled. To enable this functionality uncomment the ELK configuration, ELK links, and the environmental defined below for both the internal and external web in the docker-compose.yml file.

- LOGSTASH_HOST :: The name of the host running Logstash. If using the 'sebp/elk' image set this to 'elk'.
- LOGSTASH_PORT :: A Logstash TCP port that the Bunyan logger should send log messages to. If using the 'sebp/elk' image set this to '9998'.

### Phantomas

The prototype includes a phantomas configuration which will capture web performance metrics and send them to the ELK stack container instance.

Phantomas is a globally installed npm package which should be installed as follows:

`npm install -g phantomas`

The metrics can then be generated by runnin the included shell script at `alpha/perf-budget/run_phantomas.sh`

### Accessibility

The external web application contains an example [pa11y](http://pa11y.org/) script to audit accessibility compliance.

This script checks the running internal web application for `WCAG AA` accessibility standard violations in the HTML.

This script runs in it's own container which is launched along with all the others on `docker-compose up`

Report outputs to `./alpha/wcag_audit/html`

### SMTP debug server

The `smtp-server` container is used to receive email messages.

This container runs a self-contained python debug SMTP server and simply spills incoming emails to the console.
